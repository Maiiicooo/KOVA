<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KOVA - spots</title>
    <link rel="manifest" href="../../manifest.json" />
    <meta name="theme-color" content="#000000" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link rel="apple-touch-icon" href="../../images/appicon.JPG" />
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.2.0/maptiler-sdk.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <link
      href="https://cdn.maptiler.com/maptiler-sdk-js/v3.2.0/maptiler-sdk.css"
      rel="stylesheet"
    />

    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
      }
      .marker-clickable {
        cursor: pointer !important;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
        z-index: 0;
      }
      .navbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        display: flex;
        align-items: flex-start;
        padding: 0 20px;
        background-color: rgba(0, 0, 0, 0);
        z-index: 10;
      }
      .navbar-left {
        display: flex;
        align-items: flex-start;
        gap: 30px;
      }
      .navbar-right {
        position: absolute;
        top: 10px;
        right: 20px;
        z-index: 20;
      }
      #loginIcon {
        width: 40px;
        height: 40px;
        cursor: pointer;
      }
      .logo-time {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-top: 10px;
      }
      .navbar-logo {
        width: 70px;
        height: auto;
      }
      #time-info {
        margin-top: 4px;
        font-size: 10px;
        color: white;
        line-height: 1.2;
      }
      .navbar-items {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .navbar-items a {
        color: white;
        text-decoration: none;
        font-weight: 500;
        font-size: 16px;
        line-height: 60px;
        cursor: pointer;
        transition: color 0.3s ease;
      }
      .navbar-items a:hover {
        color: #8b7108;
      }
      .maplibregl-popup-content {
        background-color: #000 !important;
        color: white !important;
        padding: 0 !important;
      }
      .maplibregl-ctrl-bottom-left,
      .maplibregl-ctrl-logo,
      .maplibregl-ctrl-attrib,
      .maptiler-attribution {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
      }
      .spot-marker {
        width: 20px;
        height: 20px;
        background-color: #8b7108;
        border: 2px solid black;
        border-radius: 50%;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
        cursor: pointer;
        transform: translate(-50%, -50%);
      }
      .maplibregl-popup-close-button {
        color: red !important;
        background: transparent !important;
        font-size: 18px;
      }
    </style>
  </head>

  <body>
    <div class="navbar">
      <div class="navbar-left">
        <div class="logo-time">
          <img
            src="../../images/appicon-removebg-preview.png"
            alt="Logo"
            class="navbar-logo"
            id="mainLogo"
          />
          <div id="time-info"><span id="time-text">Laden…</span></div>
        </div>
        <div class="navbar-items">
          <a href="radar.html" id="wxButton">WX</a>
          <a href="radar+wind.html" id="sfButton">SF</a>
          <a href="about.html" id="aboutButton">ABOUT</a>
        </div>
        <div class="navbar-right">
          <img src="../../images/loginicon$.png" alt="Login" id="loginIcon" />
        </div>
      </div>
    </div>

    <div id="map"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        maptilersdk.config.apiKey = "7TBqy4hTdFfQeIq7oXKj";
        const map = new maptilersdk.Map({
          container: "map",
          style:
            "https://api.maptiler.com/maps/dataviz-dark/style.json?key=7TBqy4hTdFfQeIq7oXKj",
          center: [4.5, 50.85],
          zoom: 7.5,
          minZoom: 5,
          navigationControl: false,
          projectionControl: false,
          geolocateControl: false,
        });

        const firebaseConfig = {
          apiKey: "AIzaSyARxFI9HyJxrINfzDazhxFHKSrGLX8KoBk",
          authDomain: "kova-6052a.firebaseapp.com",
          projectId: "kova-6052a",
          storageBucket: "kova-6052a.firebasestorage.app",
          messagingSenderId: "873689812978",
          appId: "1:873689812978:web:e0581f3df823e51239656b",
          measurementId: "G-VM5224Z3K6",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // spots laden
        async function loadSpots() {
          try {
            const snapshot = await db.collection("spots").get();
            snapshot.forEach((doc) => {
              const spot = doc.data();
              const el = document.createElement("div");
              el.className = "spot-marker";
              const popupHTML = `
                <div style="width:250px;text-align:center;font-family:sans-serif;">
                  <img src="${
                    spot.photoURL
                  }" style="width:100%;height:auto;border-radius:6px;margin-bottom:6px;">
                  <strong>${spot.name}</strong><br>${spot.description}<br>
                  Lat: ${spot.lat.toFixed(5)}, Lng: ${spot.lng.toFixed(5)}
                </div>`;
              const popup = new maptilersdk.Popup({ offset: 25 }).setHTML(
                popupHTML
              );
              new maptilersdk.Marker({ element: el })
                .setLngLat([spot.lng, spot.lat])
                .setPopup(popup)
                .addTo(map);
            });
          } catch (err) {
            console.error("Error loading spots:", err);
          }
        }
        loadSpots();

        // geolocatie
        if (navigator.geolocation) {
          const userMarkerEl = document.createElement("img");
          userMarkerEl.src = "../../images/playericon.png";
          userMarkerEl.style.width = "28px";
          userMarkerEl.style.height = "28px";
          userMarkerEl.style.transform = "translate(-50%,-50%)";
          userMarkerEl.classList.add("marker-clickable");
          const userPopupHTML = `<div style="width:150px;text-align:center;font-family:sans-serif;">
            <img src="../../images/playeravatar.png" style="width:100%;height:auto;border-radius:6px;margin-bottom:6px;">
            <strong>This is you</strong><br></div>`;
          const userPopup = new maptilersdk.Popup({ offset: 25 }).setHTML(
            userPopupHTML
          );
          const userMarker = new maptilersdk.Marker({ element: userMarkerEl })
            .setLngLat([0, 0])
            .setPopup(userPopup)
            .addTo(map);

          navigator.geolocation.getCurrentPosition(
            (pos) => {
              userMarker.setLngLat([pos.coords.longitude, pos.coords.latitude]);
              map.setCenter([pos.coords.longitude, pos.coords.latitude]);
            },
            (err) => console.warn("Locatie fout:", err.message),
            { enableHighAccuracy: true }
          );
        }
      });

      // live tijd
      function updateTime() {
        const now = new Date();
        const timeText = document.getElementById("time-text");
        if (timeText) {
          timeText.innerText = now.toLocaleString("nl-BE", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        }
      }
      setInterval(updateTime, 1000);
      updateTime();
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script>
      const auth = firebase.auth();
      const loginIcon = document.getElementById("loginIcon");
      let currentUser = null;

      // auth state listener
      auth.onAuthStateChanged((user) => {
        currentUser = user;
        loginIcon.src = user?.photoURL || "../../images/loginicon$.png";
        loginIcon.style.borderRadius = user ? "50%" : "";
        loginIcon.style.objectFit = user ? "cover" : "";
      });

      // login knop click
      loginIcon.addEventListener("click", (e) => {
        e.stopPropagation();
        if (currentUser) {
          // dropdown toggle
          let dropdown = document.getElementById("userDropdown");
          if (!dropdown) {
            dropdown = document.createElement("div");
            dropdown.id = "userDropdown";
            dropdown.style.cssText =
              "position:absolute;top:60px;right:20px;background:#222;color:white;padding:10px;border-radius:6px;text-align:center;z-index:100;";
            dropdown.innerHTML = `
              <div><strong>${
                currentUser.displayName || "Gebruiker"
              }</strong></div>
              <button id="logoutBtn">Log out</button>
            `;
            document.body.appendChild(dropdown);
            document.getElementById("logoutBtn").onclick = () => {
              auth.signOut().then(() => location.reload());
            };
            document.addEventListener("click", function handler(ev) {
              if (!dropdown.contains(ev.target) && ev.target !== loginIcon) {
                dropdown.remove();
                document.removeEventListener("click", handler);
              }
            });
          } else {
            dropdown.remove();
          }
        } else {
          // nog niet ingelogd → loginpagina
          window.location.href = "../../web/log/login.html";
        }
      });
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const firebaseConfig = {
          apiKey: "AIzaSyARxFI9HyJxrINfzDazhxFHKSrGLX8KoBk",
          authDomain: "kova-6052a.firebaseapp.com",
          projectId: "kova-6052a",
          storageBucket: "kova-6052a.firebasestorage.app",
          messagingSenderId: "873689812978",
          appId: "1:873689812978:web:e0581f3df823e51239656b",
          measurementId: "G-VM5224Z3K6",
        };

        // Initialize Firebase **eens**
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        const loginIcon = document.getElementById("loginIcon");
        let currentUser = null;
        auth.onAuthStateChanged(async (user) => {
          currentUser = user;

          // profielfoto tonen of fallback
          loginIcon.src = user?.photoURL || "../../images/loginicon$.png";
          loginIcon.style.borderRadius = user ? "50%" : "";
          loginIcon.style.objectFit = user ? "cover" : "";

          let username = "Gebruiker";

          if (user) {
            // eerst kijken of displayName bestaat
            if (user.displayName) {
              username = user.displayName;
            } else if (user.email) {
              // fallback: gebruik e-mail voor de naam
              username = user.email.split("@")[0]; // voor @ eraf
            } else {
              // optioneel: haal uit Firestore document
              try {
                const doc = await db.collection("users").doc(user.uid).get();
                if (doc.exists) username = doc.data().displayName || username;
              } catch (err) {
                console.warn("Geen username gevonden in Firestore:", err);
              }
            }
          }

          loginIcon.title = username;

          // dropdown click
          loginIcon.onclick = (e) => {
            e.stopPropagation();
            if (!currentUser)
              return (window.location.href = "../../web/log/login.html");

            let dropdown = document.getElementById("userDropdown");
            if (!dropdown) {
              dropdown = document.createElement("div");
              dropdown.id = "userDropdown";
              dropdown.style.cssText =
                "position:absolute;top:60px;right:20px;background:transparent;color:white;padding:10px;border-radius:6px;text-align:center;z-index:100;";

              dropdown.innerHTML = `
        <div style="margin-bottom:6px;">
          <div><strong>${username}</strong></div>
        </div>
        <button id="logoutBtn">Log out</button>
      `;

              document.body.appendChild(dropdown);
              document.getElementById("logoutBtn").onclick = () =>
                auth.signOut().then(() => location.reload());

              document.addEventListener("click", function handler(ev) {
                if (!dropdown.contains(ev.target) && ev.target !== loginIcon) {
                  dropdown.remove();
                  document.removeEventListener("click", handler);
                }
              });
            } else dropdown.remove();
          };
        });
      });
    </script>
  </body>
</html>
